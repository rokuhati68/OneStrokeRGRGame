# 実装計画：一筆書きローグライクゲーム

## 概要

本実装計画は、Unity、DOTween、UniTaskを使用した一筆書きパズルローグライクゲームの開発タスクを定義します。各タスクは段階的に構築され、前のタスクの成果物を活用します。

## タスク

- [ ] 1. プロジェクト構造とコア設定のセットアップ
  - Unityプロジェクトのフォルダ構造を作成（Scripts/Model, Scripts/Presenter, Scripts/View）
  - DOTweenとUniTaskパッケージをインポート
  - GameConfigのScriptableObjectを作成
  - 基本的な型定義（TileType, GamePhase, RewardTypeなど）を実装
  - _要件: 10.1, 11.1, 12.1, 12.2_

- [ ] 2. Model層の基本データ構造を実装
  - [ ] 2.1 Playerクラスを実装
    - HP、ゴールド、攻撃力、位置のプロパティ
    - リソース操作メソッド（TakeDamage, Heal, AddGold, SpendGoldなど）
    - _要件: 11.1, 11.2, 11.3, 11.5, 11.6_
  
  - [ ]* 2.2 Playerクラスのプロパティテストを作成
    - **プロパティ: HP上限制約** - 任意のHP回復操作について、HPは最大値5を超えない
    - **検証: 要件 11.5**
  
  - [ ] 2.3 Enemyクラスを実装
    - HP、攻撃力、位置、ボスフラグのプロパティ
    - ダメージ処理と生存判定メソッド
    - ボス行動タイミング判定
    - _要件: 5.1, 5.2, 5.5, 6.1, 6.2, 13.1, 13.4_
  
  - [ ]* 2.4 Enemyクラスのプロパティテストを作成
    - **プロパティ23: 敵攻撃力の上限** - 任意の生成される敵について、その攻撃力は1から4の範囲内
    - **検証: 要件 5.5, 13.4**


- [ ] 3. Tileクラス階層を実装
  - [ ] 3.1 Tile抽象基底クラスを実装
    - Position、Typeプロパティ
    - ApplyEffect、CanApplyEffect抽象メソッド
    - TileEffectResult構造体
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [ ] 3.2 具体的なTileサブクラスを実装
    - EmptyTile、AttackBoostTile、HPRecoveryTile、GoldTile、EnemyTile
    - ThornTile、WallTile（ボス用）
    - 各タイルの効果ロジック
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 6.4, 6.5_
  
  - [ ]* 3.3 Tileクラスのプロパティテストを作成
    - **プロパティ10: 効果なしマスの無効果性** - 任意のプレイヤー状態について、効果なしマスに乗った際、状態は変化しない
    - **プロパティ11: 攻撃力上昇マスの効果** - 十分なゴールドを持つプレイヤーについて、ゴールドが1減少し、攻撃力が増加
    - **プロパティ12: HP回復マスの効果** - 十分なゴールドを持つプレイヤーについて、ゴールドが1減少し、HPが1回復
    - **プロパティ13: ゴールドマスの効果** - プレイヤーのゴールドがマスの値だけ増加
    - **プロパティ14: ゴールド不足時の効果無視** - ゴールドが0のプレイヤーについて、効果は適用されない
    - **検証: 要件 3.1, 3.2, 3.3, 3.4, 3.5, 11.3**

- [ ] 4. BoardとGameStateを実装
  - [ ] 4.1 Boardクラスを実装
    - 5×5タイル配列の管理
    - 敵リストの管理
    - タイル取得/設定、敵追加/削除メソッド
    - タイル再生成メソッド
    - _要件: 7.1, 7.2, 7.3, 10.1_
  
  - [ ] 4.2 GameStateクラスを実装
    - 現在のステージ、プレイヤー、ボード、設定の管理
    - ゲームフェーズの状態管理
    - ボスステージ判定メソッド
    - _要件: 6.1, 8.1_
  
  - [ ]* 4.3 Boardクラスのプロパティテストを作成
    - **プロパティ38: ボードサイズ** - 任意の新しいステージについて、5×5の25マスのボードが作成される
    - **プロパティ39: プレイヤー配置** - ボード初期化について、プレイヤーは有効なマス位置に配置される
    - **検証: 要件 10.1, 10.2**

- [ ] 5. タイル生成システムを実装
  - [ ] 5.1 TileSpawnConfigクラスを実装
    - 各タイプの出現率プロパティ
    - 値範囲プロパティ
    - 報酬適用メソッド
    - _要件: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_
  
  - [ ] 5.2 タイル生成ロジックを実装
    - 重み付きランダム選択アルゴリズム
    - 値範囲からのランダム値割り当て
    - _要件: 7.4, 10.4, 12.3, 12.4_
  
  - [ ]* 5.3 タイル生成のプロパティテストを作成
    - **プロパティ30: マス生成の確率分布** - 大量のマス生成について、各タイプの出現頻度は設定された出現率に統計的に近似（許容誤差±5%）
    - **プロパティ42: 攻撃力上昇マスの値範囲** - 攻撃力上昇マス生成について、値は現在の値範囲内
    - **プロパティ43: ゴールドマスの値範囲** - ゴールドマス生成について、値は現在の値範囲内
    - **検証: 要件 7.4, 10.4, 12.3, 12.4**

- [ ] 6. チェックポイント - Model層の基本機能確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [ ] 7. PathPresenterとパス検証を実装
  - [ ] 7.1 PathPresenterクラスを実装
    - パス検証メソッド（開始位置、終了位置、連続性）
    - パスプレビュー計算メソッド
    - _要件: 1.1, 1.2, 1.3, 1.4_
  
  - [ ]* 7.2 パス検証のプロパティテストを作成
    - **プロパティ1: パスはプレイヤー位置から開始** - 任意のパスについて、有効と判定されるにはプレイヤー位置から開始
    - **プロパティ2: パスは敵マスで終了** - 任意のパスについて、有効と判定されるには敵マスで終了
    - **プロパティ3: パスの連続性** - 任意のパスについて、各連続する位置が隣接し、重複がない
    - **プロパティ4: 中間敵マス通過許可** - 複数の敵を含むボードについて、最終位置以外で敵マスを通過可能
    - **検証: 要件 1.1, 1.2, 1.3, 1.4**

- [ ] 8. CombatPresenterと戦闘ロジックを実装
  - [ ] 8.1 ComboTrackerクラスを実装
    - コンボ状態の追跡
    - コンボ判定とリセットメソッド
    - _要件: 4.1, 4.2, 4.3, 4.4_
  
  - [ ] 8.2 CombatPresenterクラスを実装
    - パス実行メソッド（マス効果を順次処理）
    - タイル効果処理メソッド（コンボ考慮）
    - 戦闘処理メソッド（ダメージ計算、反撃）
    - 一筆書きボーナス適用メソッド
    - _要件: 1.5, 2.1, 2.2, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4_
  
  - [ ]* 8.3 戦闘システムのプロパティテストを作成
    - **プロパティ5: マス効果の実行順序** - 任意の有効なパスについて、マス効果はパスが訪れた順序で実行される
    - **プロパティ6: 移動による攻撃力増加** - 任意のパスについて、攻撃力は初期値 + パス長 + ブースト合計
    - **プロパティ7: 敵へのダメージ適用** - 任意の攻撃力と敵について、敵のHPは攻撃力分減少
    - **プロパティ8: ターン開始時の攻撃力リセット** - 任意のゲーム状態について、新ターン開始時に攻撃力は0
    - **プロパティ9: 一筆書きボーナス適用** - 25マス使用パスについて、ボーナス値が攻撃力に加算
    - **プロパティ19: 敵HP減少** - 任意の攻撃力と敵について、敵のHPが攻撃力分減少
    - **プロパティ20: 敵撃破判定** - 任意の敵について、HP0以下で倒された状態
    - **プロパティ21: 敵の反撃ダメージ** - 敵が生存している場合、プレイヤーHPが敵攻撃力分減少
    - **プロパティ22: ゲームオーバー条件** - プレイヤーHP0以下でゲームオーバー状態
    - **検証: 要件 1.5, 2.1, 2.2, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4**
  
  - [ ]* 8.4 コンボシステムのプロパティテストを作成
    - **プロパティ15: コンボ開始条件** - 同じ効果タイプのマスに連続2回でコンボ開始
    - **プロパティ16: コンボ中のゴールド免除** - コンボ状態で2回目以降のゴールド消費なし
    - **プロパティ17: コンボ終了条件** - 異なる効果タイプのマスでコンボ終了
    - **プロパティ18: ターン終了時のコンボリセット** - ターン終了時にすべてのコンボ状態リセット
    - **検証: 要件 4.1, 4.2, 4.3, 4.4**

- [ ] 9. BossPresenterとボスシステムを実装
  - [ ] 9.1 BossPresenterクラスを実装
    - ボス行動実行メソッド
    - ボス行動タイプのランダム選択
    - 各ボス行動の実装（攻撃力無効化、HP回復、とげマス生成、壁マス生成）
    - _要件: 6.2, 6.3, 6.4, 6.5_
  
  - [ ]* 9.2 ボスシステムのプロパティテストを作成
    - **プロパティ24: ボス出現条件** - ステージ番号が10の倍数でボス配置
    - **プロパティ25: ボス行動間隔** - ボスは指定間隔ごとに特殊行動実行
    - **プロパティ26: とげマスのダメージ** - とげマスに乗った際、指定ダメージ値だけHP減少
    - **プロパティ27: 壁マスの通行不可** - 壁マスを含むパスは無効
    - **検証: 要件 6.1, 6.2, 6.4, 6.5**

- [ ] 10. RewardSystemと報酬ロジックを実装
  - [ ] 10.1 RewardSystemクラスを実装
    - ランダム報酬選択メソッド
    - 各報酬タイプの適用ロジック
    - _要件: 8.2, 9.1, 9.2, 9.3, 9.4, 9.5_
  
  - [ ] 10.2 RewardPresenterクラスを実装
    - 報酬提示フロー制御
    - 報酬選択処理
    - _要件: 8.2, 8.3_
  
  - [ ]* 10.3 報酬システムのプロパティテストを作成
    - **プロパティ33: 報酬提示** - ステージクリア時に3つの異なる報酬タイプをランダム選択
    - **プロパティ34: 報酬効果の適用** - 任意の報酬タイプについて、対応するパラメータが永続的に変更
    - **プロパティ36: 出現率報酬の効果** - 出現率増加報酬適用後、変更された出現率を反映
    - **プロパティ37: 値報酬の効果** - 値増加報酬適用後、拡張された範囲から値を選択
    - **検証: 要件 8.2, 8.3, 9.2, 9.3, 9.4, 9.5**

- [ ] 11. チェックポイント - Presenter層の基本機能確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [ ] 12. ボード状態管理とステージ進行を実装
  - [ ] 12.1 ボード更新ロジックを実装
    - 訪問マスの削除と再生成
    - 敵撃破後のマス置き換え
    - 壁マスの永続性処理
    - _要件: 7.1, 7.2, 7.3, 7.5_
  
  - [ ] 12.2 ステージ進行ロジックを実装
    - ステージクリア判定
    - 次ステージへの遷移
    - 敵数とHPのスケーリング
    - _要件: 8.1, 8.4, 10.3, 10.5, 13.2, 13.3, 13.5_
  
  - [ ]* 12.3 ボード管理のプロパティテストを作成
    - **プロパティ28: 訪問マスの削除** - ターン終了時にパスが訪れたマス位置が削除され、新マスで置換
    - **プロパティ29: 敵撃破後のマス再生成** - 敵撃破時、その敵マス位置がランダムな新マスで置換
    - **プロパティ31: 壁マスの永続性** - ボス生成の壁マスは、プレイヤーが訪れない限りターン終了時に削除されない
    - **検証: 要件 7.1, 7.2, 7.3, 7.5**
  
  - [ ]* 12.4 ステージ進行のプロパティテストを作成
    - **プロパティ32: ステージクリア条件** - すべての敵が倒された際、ステージがクリア済み状態
    - **プロパティ35: 報酬後のステージ進行** - 報酬選択後、ステージ番号が1増加
    - **プロパティ40: 敵配置数** - 初期化時にステージ設定で指定された固定数の敵を配置
    - **プロパティ41: ステージ進行による敵数増加** - 後のステージの敵数は前のステージ以上
    - **プロパティ44: ステージ進行による敵HP増加** - ステージ番号が大きい方の敵HPは小さい方以上
    - **プロパティ45: ボスの高HP** - ボスステージについて、ボスのHPは通常敵より高い
    - **検証: 要件 8.1, 8.4, 10.3, 10.5, 13.2, 13.3, 13.5**

- [ ] 13. GamePresenterとゲームフロー制御を実装
  - [ ] 13.1 GamePresenterクラスを実装
    - ゲーム初期化メソッド
    - 新ステージ開始メソッド
    - 各フェーズのハンドラメソッド（パス描画、実行、ボス行動、ステージクリア、ゲームオーバー）
    - フェーズ遷移ロジック
    - _要件: すべての要件を統合_
  
  - [ ]* 13.2 ゲームフロー統合テストを作成
    - 完全なターンフローのテスト
    - ステージ進行フローのテスト
    - ボス戦フローのテスト

- [ ] 14. View層の基本UIを実装
  - [ ] 14.1 TileViewプレハブを作成
    - タイルの視覚表現（スプライト、テキスト）
    - ハイライト表示機能
    - DOTweenアニメーション（出現、消失、効果）
    - _要件: 14.1, 14.2, 14.3_
  
  - [ ] 14.2 BoardViewを実装
    - 5×5グリッドレイアウト
    - TileViewの動的生成と管理
    - タイル更新とアニメーション制御
    - _要件: 10.1, 14.4_
  
  - [ ] 14.3 UIViewを実装
    - HP、ゴールド、攻撃力の表示
    - ステージ番号の表示
    - 確認ダイアログ
    - ゲームオーバー画面
    - DOTweenによる値変更アニメーション
    - _要件: 11.4_

- [ ] 15. PathDrawingViewと入力システムを実装
  - [ ] 15.1 マウス入力検出を実装
    - マウスダウン、ドラッグ、アップの検出
    - タイル位置へのレイキャスト
    - _要件: UI仕様_
  
  - [ ] 15.2 パス描画の視覚フィードバックを実装
    - LineRendererによるパス表示
    - 通過マスのハイライト
    - 無効パスの視覚的フィードバック（赤色など）
    - _要件: 14.5, UI仕様_
  
  - [ ] 15.3 パスプレビュー表示を実装
    - リアルタイムの攻撃力予測表示
    - ゴールド消費予測表示
    - HP変化予測表示
    - _要件: UI仕様_
  
  - [ ] 15.4 確認ボタンUIを実装
    - パス完了時の確認ダイアログ表示
    - 決定/キャンセルボタン
    - _要件: UI仕様_

- [ ] 16. RewardViewと報酬選択UIを実装
  - [ ] 16.1 報酬選択画面を作成
    - 3つの報酬オプション表示
    - 各報酬の説明テキスト
    - 選択ボタン
    - _要件: 8.2_
  
  - [ ] 16.2 報酬選択アニメーションを実装
    - DOTweenによる報酬カード出現アニメーション
    - 選択時のフィードバックアニメーション
    - _要件: 8.2_

- [ ] 17. チェックポイント - View層の基本機能確認
  - すべてのUIが正しく表示され、入力が機能することを確認し、質問があればユーザーに尋ねる

- [ ] 18. ゲームフロー全体の統合
  - [ ] 18.1 PresenterとViewの接続
    - イベントハンドラの接続
    - UniTaskによる非同期フロー制御
    - _要件: すべての要件_
  
  - [ ] 18.2 ゲーム開始からステージクリアまでのフロー実装
    - ゲーム初期化 → ステージ開始 → ターン実行 → ステージクリア → 報酬選択 → 次ステージ
    - _要件: すべての要件_
  
  - [ ] 18.3 ボス戦フローの統合
    - ボス出現 → ボス行動 → ボス撃破
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 19. エラーハンドリングとバリデーションを実装
  - [ ] 19.1 入力検証エラーハンドリング
    - 無効なパスの検出と視覚的フィードバック
    - エラーメッセージ表示
    - _要件: 1.1, 1.2, 1.3_
  
  - [ ] 19.2 リソース不足エラーハンドリング
    - ゴールド不足時の処理
    - HP上限超過時の処理
    - _要件: 3.5, 11.3, 11.5_
  
  - [ ] 19.3 ゲーム状態エラーハンドリング
    - ゲームオーバー状態での入力無効化
    - 無効な状態遷移の防止
    - _要件: 5.4_

- [ ] 20. GameConfigとバランス調整
  - [ ] 20.1 GameConfig ScriptableObjectの設定
    - 初期値の設定（HP、ゴールド、ボーナス）
    - タイル出現率の設定
    - 敵生成テーブルの設定
    - 報酬設定
    - _要件: 11.1, 11.2, 11.6, 12.1, 12.2, 13.1_
  
  - [ ] 20.2 ステージごとの難易度スケーリング設定
    - 各ステージの敵数、HP、攻撃力の定義
    - ボスステージの設定
    - _要件: 10.3, 10.5, 13.2, 13.3, 13.5_

- [ ] 21. ビジュアルとアニメーションの洗練
  - [ ] 21.1 タイルアニメーションの実装
    - 出現アニメーション（スケール、フェード）
    - 消失アニメーション
    - 効果発動アニメーション
    - _要件: 14.1, 14.2, 14.3_
  
  - [ ] 21.2 戦闘アニメーションの実装
    - 攻撃エフェクト
    - ダメージ表示
    - 敵撃破エフェクト
    - _要件: 5.1, 5.2, 5.3_
  
  - [ ] 21.3 ボス行動アニメーションの実装
    - 各ボス行動の視覚効果
    - 特殊マス生成エフェクト
    - _要件: 6.6, 14.7_
  
  - [ ] 21.4 コンボ表示の実装
    - コンボカウンター表示
    - コンボ中の視覚的フィードバック
    - _要件: 14.6_

- [ ] 22. 最終チェックポイント - 全機能の統合テスト
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [ ] 23. パフォーマンス最適化
  - [ ] 23.1 オブジェクトプーリングの実装
    - TileViewのプーリング
    - エフェクトオブジェクトのプーリング
  
  - [ ] 23.2 ガベージコレクション削減
    - Listの事前確保
    - 不要なアロケーションの削除
  
  - [ ] 23.3 描画最適化
    - スプライトアトラスの作成
    - バッチング最適化

- [ ] 24. デバッグ機能の実装
  - [ ] 24.1 デバッグUI
    - ゲーム状態の表示
    - チートコマンド（HP回復、ゴールド追加など）
  
  - [ ] 24.2 ログシステム
    - 適切なログレベルの設定
    - 重要なゲームイベントのログ記録

## 注意事項

- `*`マークの付いたタスクはオプションであり、より早いMVPのためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントタスクは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します

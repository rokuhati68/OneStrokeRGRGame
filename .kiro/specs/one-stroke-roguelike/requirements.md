# 要件定義書

## はじめに

本ドキュメントは、プレイヤーがグリッド上に連続したパスを描いて移動を決定し、リソースを収集し、敵を倒す一筆書きパズルローグライクゲームの要件を定義します。このゲームは戦略的なパス計画とローグライク進行要素を組み合わせています。

## 用語集

- **プレイヤー**: ゲームボード上を移動するユーザー制御エンティティ
- **ゲームボード**: 25マスからなる5×5のグリッド
- **一筆書きパス**: プレイヤーが描く、持ち上げたり引き返したりせずにマスを訪れる連続したパス
- **マス**: ゲームボード上の1つの正方形で、特定の効果を持つ
- **攻撃力**: 各マス移動ごとに増加する累積ダメージ値
- **敵マス**: HPと攻撃力を持つ敵が配置されたマス
- **ゴールド**: 特定のマス効果を発動するために使用する通貨
- **ステージ**: 倒すべき敵を含む完全なレベル
- **報酬**: ステージクリア後に獲得する永続的なアップグレード
- **一筆書きボーナス**: 25マスすべてを1つのパスで使用した際に付与される追加攻撃力
- **コンボ**: 同じ効果のマスに連続して乗った際に発生し、2回目以降のゴールド消費が不要になる効果
- **ボス**: 10ステージごとに出現する特殊な敵で、数ターンに一回行動する能力を持つ
- **ボス行動**: ボスが実行する特殊な行動（マス効果無効化、HP回復、特殊マス生成など）

## 要件

### 要件1: 一筆書きパス移動

**ユーザーストーリー:** プレイヤーとして、一筆書きパスを描いて移動順序を決定したい。そうすることで、ターンの行動を戦略的に計画できる。

#### 受入基準

1. WHEN プレイヤーがパスを描く THEN ゲームシステムは、パスがプレイヤーの現在のマスから始まることを検証しなければならない
2. WHEN プレイヤーがパスを描く THEN ゲームシステムは、パスが敵マスで終わることを検証しなければならない
3. WHEN プレイヤーがパスを描く THEN ゲームシステムは、パスが持ち上げたり引き返したりせずに連続していることを検証しなければならない
4. WHEN ゲームボードに複数の敵が存在する THEN ゲームシステムは、最終マスの前に敵マスを通過することを許可しなければならない
5. WHEN プレイヤーが有効なパスを完成させる THEN ゲームシステムは、パスが訪れた順序でマス効果を実行しなければならない

### 要件2: 攻撃力蓄積

**ユーザーストーリー:** プレイヤーとして、移動するにつれて攻撃力を蓄積したい。そうすることで、敵にダメージを与えることができる。

#### 受入基準

1. WHEN プレイヤーが新しいマスに移動する THEN ゲームシステムは、攻撃力を1増加させなければならない
2. WHEN プレイヤーが敵マスに乗る THEN ゲームシステムは、現在の攻撃力に等しいダメージをその敵に与えなければならない
3. WHEN ターンが開始される THEN ゲームシステムは、攻撃力を0にリセットしなければならない
4. WHEN プレイヤーが1つのパスで25マスすべてを使用する THEN ゲームシステムは、最後の敵を攻撃する前に一筆書きボーナス値を攻撃力に加算しなければならない

### 要件3: マスの種類と効果

**ユーザーストーリー:** プレイヤーとして、異なる効果を持つマスの種類が欲しい。そうすることで、パスについて戦略的な決定を下すことができる。

#### 受入基準

1. WHEN プレイヤーが効果なしマスに乗る THEN ゲームシステムは、効果を適用しないこととする
2. WHEN プレイヤーが十分なゴールドを持って攻撃力上昇マスに乗る THEN ゲームシステムは、1ゴールドを消費し、マスに表示された値だけ攻撃力を増加させなければならない
3. WHEN プレイヤーが十分なゴールドを持ってHP回復マスに乗る THEN ゲームシステムは、1ゴールドを消費し、プレイヤーのHPを1回復させなければならない
4. WHEN プレイヤーがゴールドマスに乗る THEN ゲームシステムは、マスに表示されたゴールド値をプレイヤーのゴールド合計に加算しなければならない
5. WHEN プレイヤーが十分なゴールドを持たずにマスに乗る THEN ゲームシステムは、そのマスの効果を無視しなければならない

### 要件4: コンボシステム

**ユーザーストーリー:** プレイヤーとして、同じ効果のマスに連続して乗った際にボーナスを得たい。そうすることで、効率的なパス計画が報われる。

#### 受入基準

1. WHEN プレイヤーが同じ効果タイプのマスに連続して乗る THEN ゲームシステムは、コンボ状態を開始しなければならない
2. WHEN コンボ状態が有効である THEN ゲームシステムは、2回目以降の同じ効果タイプのマスでゴールド消費を免除しなければならない
3. WHEN プレイヤーが異なる効果タイプのマスに乗る THEN ゲームシステムは、コンボ状態を終了しなければならない
4. WHEN ターンが終了する THEN ゲームシステムは、すべてのコンボ状態をリセットしなければならない
5. THE ゲームシステムは、攻撃力上昇マスとHP回復マスのコンボをサポートしなければならない

### 要件5: 敵との戦闘

**ユーザーストーリー:** プレイヤーとして、敵のマスに乗ることで敵と戦いたい。そうすることで、ステージを進行できる。

#### 受入基準

1. WHEN プレイヤーが敵マスに乗る THEN ゲームシステムは、プレイヤーの現在の攻撃力だけ敵のHPを減少させなければならない
2. WHEN 敵のHPが0以下になる THEN ゲームシステムは、その敵を倒された状態としてマークしなければならない
3. WHEN プレイヤーが敵マスに乗り、敵が生き残る THEN ゲームシステムは、敵の攻撃力だけプレイヤーのHPを減少させなければならない
4. WHEN プレイヤーのHPが0以下になる THEN ゲームシステムは、ゲームオーバーをトリガーしなければならない
5. THE ゲームシステムは、敵の攻撃力を最大4までに制限しなければならない

### 要件6: ボス戦

**ユーザーストーリー:** プレイヤーとして、10ステージごとに特殊な能力を持つボスと戦いたい。そうすることで、ゲームに変化と挑戦が生まれる。

#### 受入基準

1. WHEN ステージ番号が10の倍数である THEN ゲームシステムは、そのステージにボスを配置しなければならない
2. WHEN ボスが存在する THEN ゲームシステムは、数ターンに一回ボス行動を実行しなければならない
3. THE ゲームシステムは、以下のボス行動タイプをサポートしなければならない：攻撃力上昇マス効果無効化、ボスHP回復、とげマス生成、壁マス生成
4. WHEN ボスがとげマスを生成する THEN ゲームシステムは、プレイヤーがそのマスに乗った際にダメージを与えるマスを配置しなければならない
5. WHEN ボスが壁マスを生成する THEN ゲームシステムは、プレイヤーが通過できないマスを配置しなければならない
6. WHEN ボス行動が実行される THEN ゲームシステムは、プレイヤーにボス行動の視覚的フィードバックを提供しなければならない

### 要件7: ボード状態管理

**ユーザーストーリー:** プレイヤーとして、各ターン後にボードが更新されることを望む。そうすることで、ゲームがダイナミックで挑戦的なままになる。

#### 受入基準

1. WHEN ターンが終了する THEN ゲームシステムは、そのターン中にプレイヤーが訪れたすべてのマスを削除しなければならない
2. WHEN マスが削除される THEN ゲームシステムは、新しくランダムに生成されたマスでそれらを置き換えなければならない
3. WHEN プレイヤーが敵を倒す THEN ゲームシステムは、その敵マスをランダムな位置の新しくランダムに生成されたマスで置き換えなければならない
4. WHEN 新しいマスを生成する THEN ゲームシステムは、現在のマス出現率確率を使用しなければならない
5. WHEN ボスが壁マスを生成している THEN ゲームシステムは、ターン終了時に壁マスを削除してはならない

### 要件8: ステージ進行

**ユーザーストーリー:** プレイヤーとして、すべての敵を倒してステージをクリアしたい。そうすることで、報酬を獲得して進行できる。

#### 受入基準

1. WHEN ステージ内のすべての敵が倒される THEN ゲームシステムは、ステージをクリア済みとしてマークしなければならない
2. WHEN ステージがクリアされる THEN ゲームシステムは、ランダムに選択された3つの報酬をプレイヤーに提示しなければならない
3. WHEN プレイヤーが報酬を選択する THEN ゲームシステムは、その報酬の永続的な効果を適用しなければならない
4. WHEN 報酬が適用される THEN ゲームシステムは、次のステージに進まなければならない
5. THE ゲームシステムは、無限にステージを生成し続けなければならない

### 要件9: 報酬システム

**ユーザーストーリー:** プレイヤーとして、異なる永続的なアップグレードから選択したい。そうすることで、ステージ間で戦略をカスタマイズできる。

#### 受入基準

1. THE ゲームシステムは、以下の報酬タイプをサポートしなければならない：攻撃力上昇マス出現率増加、攻撃力上昇マス値増加、HP回復マス出現率増加、効果なしマス出現率増加、ゴールドマス出現率増加、ゴールドマス値増加、一筆書きボーナス値増加
2. WHEN 報酬が選択される THEN ゲームシステムは、対応するゲームパラメータを永続的に変更しなければならない
3. WHEN 報酬を提示する THEN ゲームシステムは、利用可能なプールから3つの異なる報酬タイプをランダムに選択しなければならない
4. WHEN 報酬が出現率を変更する THEN ゲームシステムは、すべての後続のマス生成に新しい率を適用しなければならない
5. WHEN 報酬が値を変更する THEN ゲームシステムは、マスに表示される値の範囲を増加させなければならない

### 要件10: ゲームボード初期化

**ユーザーストーリー:** プレイヤーとして、適切に設定されたボードでゲームを開始したい。そうすることで、すぐにプレイを始められる。

#### 受入基準

1. WHEN 新しいステージが開始される THEN ゲームシステムは、25マスの5×5ゲームボードを作成しなければならない
2. WHEN ボードを初期化する THEN ゲームシステムは、プレイヤーを開始マスに配置しなければならない
3. WHEN ボードを初期化する THEN ゲームシステムは、ステージに応じた固定数の敵マスを配置しなければならない
4. WHEN ボードを初期化する THEN ゲームシステムは、現在の出現率確率に従ってマスをランダムに生成しなければならない
5. WHEN ステージ番号が増加する THEN ゲームシステムは、配置される敵の数を増加させなければならない

### 要件11: リソース管理

**ユーザーストーリー:** プレイヤーとして、ゴールドとHPリソースを管理したい。そうすることで、マス効果について戦略的な決定を下すことができる。

#### 受入基準

1. WHEN ゲームが開始される THEN ゲームシステムは、プレイヤーのHPを最大HP値5で初期化しなければならない
2. WHEN 新しいステージが開始される THEN ゲームシステムは、プレイヤーのゴールドを初期値（デフォルト50）で初期化しなければならない
3. WHEN プレイヤーのゴールドがマス効果に不十分である THEN ゲームシステムは、効果の発動を防止しなければならない
4. THE ゲームシステムは、常に現在のHPとゴールド値をプレイヤーに表示しなければならない
5. WHEN プレイヤーのHPが回復される THEN ゲームシステムは、HPが最大HP値5を超えないようにしなければならない
6. THE ゲームシステムは、一筆書きボーナスの初期値を5に設定しなければならない

### 要件12: マス生成パラメータ

**ユーザーストーリー:** プレイヤーとして、バランスの取れたマス分布でゲームをプレイしたい。そうすることで、公平で挑戦的な体験ができる。

#### 受入基準

1. THE ゲームシステムは、効果なしマスの初期出現率を70%に設定しなければならない
2. THE ゲームシステムは、攻撃力上昇マス、HP回復マス、ゴールドマスの初期出現率をそれぞれ10%に設定しなければならない
3. WHEN 攻撃力上昇マスを生成する THEN ゲームシステムは、1から2の範囲でランダムに値を割り当てなければならない
4. WHEN ゴールドマスを生成する THEN ゲームシステムは、1から2の範囲でランダムに値を割り当てなければならない
5. WHEN 報酬が出現率を増加させる THEN ゲームシステムは、対応するマスタイプの出現率を5%増加させなければならない
6. WHEN 報酬がマス値を増加させる THEN ゲームシステムは、そのマスタイプの値範囲を拡張しなければならない

### 要件13: 敵生成パラメータ

**ユーザーストーリー:** プレイヤーとして、ステージが進むにつれて難易度が上がることを望む。そうすることで、継続的な挑戦が得られる。

#### 受入基準

1. WHEN ステージ1が開始される THEN ゲームシステムは、HP10、攻撃力1の敵を1体配置しなければならない
2. WHEN ステージ番号が増加する THEN ゲームシステムは、敵のHPを増加させなければならない
3. WHEN ステージ番号が増加する THEN ゲームシステムは、配置される敵の数を増加させることができる
4. THE ゲームシステムは、敵の攻撃力を1から4の範囲に制限しなければならない
5. WHEN ボスステージである THEN ゲームシステムは、通常の敵よりも高いHPを持つボスを配置しなければならない

### 要件14: 視覚的フィードバック

**ユーザーストーリー:** プレイヤーとして、マスとゲーム状態について明確な視覚情報が欲しい。そうすることで、情報に基づいた決定を下すことができる。

#### 受入基準

1. WHEN 攻撃力上昇マスを表示する THEN ゲームシステムは、マス上に攻撃力値を表示しなければならない
2. WHEN ゴールドマスを表示する THEN ゲームシステムは、マス上にゴールド値を表示しなければならない
3. WHEN 敵マスを表示する THEN ゲームシステムは、マス上に敵のHPと攻撃力の両方を表示しなければならない
4. WHEN ゲームボードを表示する THEN ゲームシステムは、プレイヤーの現在位置を明確に示さなければならない
5. WHEN プレイヤーがパスを描く THEN ゲームシステムは、描かれているパスを示す視覚的フィードバックを提供しなければならない
6. WHEN コンボが有効である THEN ゲームシステムは、現在のコンボ状態を視覚的に示さなければならない
7. WHEN ボスが行動する THEN ゲームシステムは、ボス行動のアニメーションまたは視覚的効果を表示しなければならない

